package slp

import (
	"bytes"
	"encoding/json"
	"fmt"
	"io"

	"github.com/airforce270/mc-srv/packet"
	"github.com/airforce270/mc-srv/packet/id"
	"github.com/airforce270/mc-srv/packet/types"
	"github.com/airforce270/mc-srv/packet/writepacket"
	"github.com/airforce270/mc-srv/write"
)

const (
	version     = "1.20.4"
	iconDataURI = "data:image/png;base64,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CTDLbIepbpqGk/cg4xDthaNY2bOfXiDAsbiP1SzFwvLyJz51/w//+3qNO5HzTisAdMPfvXTHn9dqxY81qj4u2b4VZc+DZR9/k0S68P0S6vUmbTHBYHERCYkiwREGHaTU6+91sbe9jGPLy08urHauvPuJmZfc7Xkihr4stcCvuui150xsqTdLT23cMF14zfazsKFchDADO45+PzJdolKxirztgCsJniTwbBtrQRfzi0t4bmEBSc4ZPHN470V//9DMgVMx7kTOPe0eYLzg8q3vLVdqn3/1jrPZxWefBdoa5jgCw2CIdrePTqcHxT0z++e0WzxJzfY5emvELdflT5975oNffOipL56IAad6zMsCwB9ctcVrxWzPBdu2nfHmCy9EvVxCzhZG4iZhjGAQoN3toj/om2EmTX84d8AcB61EffVDd9797hN94eH/SwDood543uS5Z0xvePwN519Q3jw5jo3jZeRzLmQcm/KXOry0tY3eCxwMQjNACRR+vG/pwFtu//K/ntRw41RAeFk84PkHevtrt9924TnnfvqMyRrb2iigWaua93xoyut4DrI0QxzRrH+AzlAuDDN91bs/95Vfu6fvVAz9jZHgL9/oXde8/i+3bZj8w7qrsLk5BscavUQx6hhpDIcBBmE8O1Ds0lv+4suLL4eRL3bNl9UD6Mbv27nT7jr4s+ZY/hMbm3VGL0jGYWJmAINgQK/RfqGU8/74w//z3sFv2vjTKoVf7OHpXcM9F5/zBm5b73YdscPhTlAt1x6J0uD+O7/9yO7fFOH9qmf8fztQVQSLWQvjAAAAAElFTkSuQmCC"
)

// Zero-field packet that should be ignored.
// https://wiki.vg/Server_List_Ping#Status_Request
type StatusRequest struct {
	packet.Header
}

func (sr StatusRequest) Name() string { return "StatusRequest" }

type statusResponseJSON struct {
	Version            statusResponseVersion `json:"version"`
	Players            statusResponsePlayers `json:"players"`
	Description        types.TextComponent   `json:"description"`
	Favicon            string                `json:"favicon"`
	EnforcesSecureChat bool                  `json:"enforcesSecureChat"`
	PreviewsChat       bool                  `json:"previewsChat"`
}
type statusResponseVersion struct {
	Name     string `json:"name"`
	Protocol int    `json:"protocol"`
}
type statusResponsePlayers struct {
	Max     int                    `json:"max"`
	Online  int                    `json:"online"`
	Samples []statusResponseSample `json:"sample"`
}
type statusResponseSample struct {
	Name string `json:"name"`
	ID   string `json:"id"`
}

func NewStatusResponse(protocol int) (StatusResponse, error) {
	resp, err := json.Marshal(statusResponseJSON{
		Version: statusResponseVersion{
			Name:     version,
			Protocol: protocol,
		},
		Players: statusResponsePlayers{
			Max:     34,
			Online:  12,
			Samples: nil,
		},
		Description: types.TextComponent{
			Text: "The Minecraft client-server protocol kinda sucks ngl",
		},
		Favicon:            iconDataURI,
		EnforcesSecureChat: false,
		PreviewsChat:       false,
	})
	if err != nil {
		return StatusResponse{}, fmt.Errorf("failed to marshal status response as JSON: %w", err)
	}

	return StatusResponse{JSONResponse: string(resp)}, nil
}

// StatusResponse is the information the server sends
// to populate the server entry on the client.
//
// https://wiki.vg/Server_List_Ping#Status_Response
type StatusResponse struct {
	// JSON object with a specific format, as detailed in:
	// https://wiki.vg/Server_List_Ping#Status_Response
	JSONResponse string
}

// Write writes the StatusResponse to the writer.
// https://wiki.vg/Server_List_Ping#Status_Response
func (sr StatusResponse) Write(w io.Writer) error {
	var buf bytes.Buffer
	if err := write.String(&buf, sr.JSONResponse); err != nil {
		return fmt.Errorf("failed to write status response JSON: %w", err)
	}

	if err := writepacket.Write(w, id.StatusResponse, &buf); err != nil {
		return fmt.Errorf("failed to write packet: %w", err)
	}

	return nil
}
